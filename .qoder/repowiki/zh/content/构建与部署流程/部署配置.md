# 部署配置

<cite>
**本文档引用的文件**  
- [netlify.toml](file://netlify.toml)
- [package.json](file://package.json)
- [functions/ai-chat.js](file://functions/ai-chat.js)
- [functions/hello.js](file://functions/hello.js)
- [functions/wallpaper.js](file://functions/wallpaper.js)
- [functions/utils/common.js](file://functions/utils/common.js)
- [src/app/common/api.ts](file://src/app/common/api.ts)
- [src/app/demo/api.ts](file://src/app/demo/api.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [构建配置分析](#构建配置分析)
3. [头信息配置与跨域策略](#头信息配置与跨域策略)
4. Next.js 插件集成
5. 构建脚本与本地开发一致性
6. 部署流程指南
7. 常见问题与解决方案

## 项目结构

本项目采用标准的 Next.js 应用结构，结合 Netlify 的云函数与插件系统进行部署优化。核心目录包括：

- `src/app`: Next.js App Router 模式下的页面与组件
- `public/files`: 静态 Markdown 文件资源
- `functions`: Netlify 云函数实现，包含 `ai-chat.js`、`hello.js`、`wallpaper.js` 等
- `netlify.toml`: 部署配置文件，定义构建、发布、函数路径等
- `package.json`: 包含构建脚本与依赖

**Section sources**
- [netlify.toml](file://netlify.toml#L1-L20)
- [package.json](file://package.json#L1-L46)

## 构建配置分析

`netlify.toml` 文件中的 `[build]` 段定义了部署的核心行为：

- `command = "npm run build"`：指定构建命令，调用 `package.json` 中的 `build` 脚本
- `publish = ".next"`：指定构建输出目录为 `.next`，这是 Next.js 默认的构建产物目录
- `functions = "functions"`：指定云函数存放路径为 `functions` 目录，Netlify 会自动识别并部署该目录下的函数
- `cache = { paths = ["node_modules"] }`：启用缓存策略，缓存 `node_modules` 以加速后续构建

该配置确保了构建过程与 Next.js 的默认行为一致，并通过函数目录支持后端逻辑扩展。

**Section sources**
- [netlify.toml](file://netlify.toml#L1-L5)

## 头信息配置与跨域策略

`netlify.toml` 中的 `[[headers]]` 配置用于设置 HTTP 响应头，提升安全性与性能：

```toml
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
```

此配置针对所有云函数路径启用 CORS，允许任意来源的请求，支持 `GET`、`POST`、`OPTIONS` 方法，并允许 `Content-Type` 和 `Authorization` 请求头，确保前端可顺利调用后端 API。

另一条规则用于静态资源缓存：

```toml
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000"
```

对 `/assets/*` 路径下的资源设置一年的强缓存，提升加载性能。

**Section sources**
- [netlify.toml](file://netlify.toml#L7-L18)

## Next.js 插件集成

```toml
[[plugins]]
  package = "@netlify/plugin-nextjs"
```

`@netlify/plugin-nextjs` 是 Netlify 官方提供的 Next.js 集成插件，其作用包括：

- 自动处理 Next.js 的静态生成（SSG）、服务端渲染（SSR）和增量静态再生（ISR）
- 支持 `next/image` 的优化图像服务
- 正确路由 `/_next/*`、`/api/*` 等 Next.js 特殊路径
- 与 Netlify 边缘网络集成，提升全球访问性能

该插件无需额外配置，安装后自动生效，确保 Next.js 应用在 Netlify 上完整运行。

**Section sources**
- [netlify.toml](file://netlify.toml#L20-L21)
- [package.json](file://package.json#L15)

## 构建脚本与本地开发一致性

`package.json` 中的 `scripts` 字段定义了开发与构建流程：

```json
"scripts": {
  "dev": "next dev -p 8200",
  "build": "node scripts/handXlsxToJson.js && next build",
  "start": "next start",
  "lint": "next lint"
}
```

- `dev`: 本地开发启动命令，监听 8200 端口
- `build`: 构建命令，先执行 `handXlsxToJson.js` 脚本（用于将 Excel 转换为 JSON 数据），再执行 `next build`
- `start`: 启动生产服务器，用于本地预览构建结果

构建命令与 `netlify.toml` 中的 `command` 一致，确保本地构建与生产部署行为一致，避免环境差异导致的问题。

**Section sources**
- [package.json](file://package.json#L5-L12)

## 部署流程指南

1. **本地开发**：运行 `npm run dev` 启动开发服务器
2. **构建测试**：运行 `npm run build` 验证构建是否成功
3. **提交代码**：将代码推送到 Git 仓库（如 GitHub）
4. **Netlify 自动部署**：
   - Netlify 检测到代码变更
   - 执行 `npm run build` 构建命令
   - 将 `.next` 目录作为静态文件发布
   - 部署 `functions` 目录中的云函数
   - 应用 `[[headers]]` 中的头信息规则
5. **访问站点**：部署完成后，Netlify 提供预览 URL 或自定义域名访问

## 常见问题与解决方案

### 1. 云函数无法访问（404 错误）

**问题原因**：函数路径配置错误或函数文件未正确导出 `handler`

**解决方案**：
- 确保 `netlify.toml` 中 `functions = "functions"` 指向正确目录
- 每个函数文件必须导出 `handler` 函数，如 `exports.handler = async (event) => {}`
- 访问路径为 `/.netlify/functions/function-name`

**Section sources**
- [functions/hello.js](file://functions/hello.js#L1-L8)
- [netlify.toml](file://netlify.toml#L4)

### 2. CORS 头未生效

**问题原因**：函数内部手动设置了 `headers`，覆盖了 `netlify.toml` 的配置

**解决方案**：
- 在函数返回时，合并 `CORS_HEADERS`，如 `headers: { ...CORS_HEADERS, 'Content-Type': 'application/json' }`
- 使用统一的 `CORS_HEADERS` 导出，如 `functions/utils/common.js` 中定义

```js
export const CORS_HEADERS = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization",
};
```

**Section sources**
- [functions/utils/common.js](file://functions/utils/common.js#L1-L5)
- [functions/ai-chat.js](file://functions/ai-chat.js#L1-L2)
- [netlify.toml](file://netlify.toml#L7-L12)

### 3. 构建失败：`handXlsxToJson.js` 执行错误

**问题原因**：脚本依赖的 `xlsx` 模块未正确安装或文件路径错误

**解决方案**：
- 确保 `xlsx` 在 `package.json` 的 `dependencies` 中
- 检查脚本路径 `scripts/handXlsxToJson.js` 是否存在
- 在本地运行 `node scripts/handXlsxToJson.js` 验证脚本逻辑

**Section sources**
- [package.json](file://package.json#L20)
- [scripts/handXlsxToJson.js](file://scripts/handXlsxToJson.js)

### 4. 静态资源缓存未生效

**问题原因**：资源未部署到 `/assets/*` 路径，或头信息规则未匹配

**解决方案**：
- 确保静态资源放置在 `public/assets/` 目录下
- 验证 `netlify.toml` 中的 `for = "/assets/*"` 规则是否正确
- 清除浏览器缓存或使用无痕模式测试

**Section sources**
- [netlify.toml](file://netlify.toml#L14-L18)